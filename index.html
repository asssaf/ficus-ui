<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8">
  <title>Main</title>
  <!--<link rel="stylesheet" href="whatever-you-want.css">-->
  <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/4.8.0/firebase-ui-auth.css" />
  <script src="https://www.gstatic.com/firebasejs/8.5.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.5.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.5.0/firebase-firestore.js"></script>
  <script src="main.js"></script>
  <script src="config.js"></script>
</head>
<body>
  <div id="myapp"></div>
  <script>
    firebase.initializeApp({
      apiKey: apiKey,
      authDomain: authDomain,
      projectId: projectId
    });

    var provider = new firebase.auth.GoogleAuthProvider();

    var queryHandles = {}

    signIn = function() {
      firebase.auth().signInWithRedirect(provider)
    }

    signOut = function() {
      firebase.auth().signOut().then(() => {
        // Sign-out successful.
      }).catch((error) => {
        // An error happened.
      });
    }

    start = function(user) {
      flags = {
        user: user,
        width: window.innerWidth,
        height: window.innerHeight,
      }
      console.log("flags", flags)
      var app = Elm.Main.init({
        node: document.getElementById('myapp'),
        flags: flags,
      });

      var db = firebase.firestore();

      const params = new URLSearchParams(window.location.search)
      if (params.has('emulator')) {
        db.useEmulator("localhost", 38080)
      }

      app.ports.signIn.subscribe(function(message) {
        signIn();
      });

      app.ports.signOut.subscribe(function(message) {
        signOut();
      });

      app.ports.sendQuery.subscribe(function(query) {
        console.log("query", JSON.stringify(query))

        // if the handle is already registered, unregister it first
        prevHandle = queryHandles[query.id]
        if (prevHandle) {
          prevHandle()
        }

        var q = db

        if (query.collectionGroup) {
          q = q.collectionGroup(query.path[0])

        } else {
          for (i = 0; i < query.path.length; i++) {
            var pathElement = query.path[i]
            if (i % 2 == 0) {
              q = q.collection(pathElement)
            } else {
              q = q.doc(pathElement)
            }
          }
        }

        if (query.orderBy) {
          q = q.orderBy(query.orderBy.field, query.orderBy.dir)
        }

        if (query.limit) {
          q = q.limit(query.limit)
        }

        docToItem = (doc) => {
          var data = doc.data()
          data.id = doc.id
          data.path = doc.ref.path
          if (doc.ref.parent && doc.ref.parent.parent) {
            data.parentID = doc.ref.parent.parent.id
          }
          var item = {
            "id": doc.id,
            "data": data,
          }

          return item
        }

        var snapshotHandler
        if (query.path.length % 2 == 1) {
          snapshotHandler = (querySnapshot) => {
            console.log("snapshot", querySnapshot)
            var docs = []
            querySnapshot.forEach((doc) => {
              item = docToItem(doc)
              docs.push(item)
            })
            snapshot = {
              "id": query.id,
              "docs": docs,
            }
            console.log("query result sent", JSON.stringify(snapshot))
            app.ports.queryResponseReceiver.send(snapshot)
          }

        } else {
          snapshotHandler = (doc) => {
            console.log("doc", doc)
            item = docToItem(doc)
            var snapshot = {
              "id": query.id,
              "docs": [ item ],
            }
            console.log("query result sent", JSON.stringify(snapshot))
            app.ports.queryResponseReceiver.send(snapshot)
          }
        }

        var handle = q.onSnapshot(snapshotHandler, (error) => console.log("error in listener", query.id, error))
        queryHandles[query.id] = handle
      });
    }

    initApp = function() {
      firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
          // User is signed in.
          // var displayName = user.displayName;
          // var email = user.email;
          // var emailVerified = user.emailVerified;
          // var uid = user.uid;
          // var providerData = user.providerData;
          // var providerId = providerData.providerId;
          // var providerUid = providerData.uid;
          user.getIdToken().then(function(accessToken) {
            start(user)
          })
        } else {
          start(user)
        }
      }, function(error) {
        console.log(error);
      });
    };

    window.addEventListener('load', function() {
      initApp()
    });

    window.addEventListener('visibilitychange', function() {
      console.log("visibility change", document.visibilityState)
    });

  </script>
</body>
</html>
